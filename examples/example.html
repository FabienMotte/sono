<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>sono - Example</title>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <h1>sono</h1>

    <section>

        <div class="Player">
          <div class="Player-inner" data-js="inner">
            <div class="Player-play"></div>
            <div class="Player-pause"></div>
          </div>
          <div class="Player-mask Player-maskA">
            <div class="Player-half Player-halfA" data-js="a"></div>
          </div>
          <div class="Player-mask Player-maskB">
            <div class="Player-half Player-halfB" data-js="b"></div>

          </div>
              <canvas class="Player-canvas" width="760" height="760"></canvas>
          <canvas class="Player-canvas" width="760" height="760"></canvas>
        </div>

    </section>

    <script>
        // Test with no WebAudio
        if(window.location.search.slice(1) === 'nowebaudio') {
            window.AudioContext = window.webkitAudioContext = undefined;
        }
    </script>
    <script src="../dist/sono.js"></script>
    <script>
        (function() {
            'use strict';

            sono.log();

            var baseURL = 'https://dl.dropboxusercontent.com/u/15470024/prototypes/audio/',
                sound = sono.createSound({
                    url: [
                        baseURL + 'dnb-loop-3.ogg',
                        baseURL + 'dnb-loop-3.mp3'
                    ],
                    loop: false
                })
                .on('loaded', start)
                .on('ended', function() {
                    console.log('sound ended');
                    player.classList.toggle('is-playing', false);
                });

            var player = document.querySelector('.Player'),
                inner = player.querySelector('[data-js="inner"]'),
                elA = document.querySelector('[data-js="a"]'),
                elB = document.querySelector('[data-js="b"]'),
                canvas = document.querySelectorAll('canvas'),
                ctxA = canvas[0].getContext('2d'),
                ctxB = canvas[1].getContext('2d'),
                analyser,
                waveform = sound.waveform(360),
                height = canvas[0].height,
                origin = height / 2,
                radius = height / 4,
                angle,
                circ = Math.PI * 2,
                step,
                x,
                y,
                magnitude,
                colorProgress = 'rgb(255,0,255)',
                colorWaveform = 'rgba(255, 0, 255, 0.6)';

            function setRotation(el, deg) {
                var transform = 'rotate(' + deg + 'deg)';
                el.style.webkitTransform = transform;
                el.style.transform = transform;
            }

            function update() {
                window.requestAnimationFrame(update);

                var progress = sound.progress;

                var rotation = progress * 360;

                setRotation(elA, Math.min(rotation, 180));

                setRotation(elB, Math.max(rotation - 180, 0));

                drawWaveform(ctxB, colorProgress, progress);
            }

            function drawWaveform(ctx, color, percent) {
                step = circ / waveform.length;
                ctx.lineWidth = 1.5;
                ctx.strokeStyle = color;
                ctx.clearRect(0, 0, height, height);
                ctx.beginPath();

                for(var i = 0; i < waveform.length * percent; i++) {
                    angle = i * step - Math.PI / 2;
                    x = origin + radius * Math.cos(angle);
                    y = origin + radius * Math.sin(angle);
                    ctx.moveTo(x, y);

                    magnitude = radius + radius * waveform[i];
                    x = origin + magnitude * Math.cos(angle);
                    y = origin + magnitude * Math.sin(angle);
                    ctx.lineTo(x, y);
                }
                ctx.stroke();
            }

            function togglePlay() {
                if(sound.playing) {
                    sound.pause();
                } else {
                    sound.play();
                    update();
                }
                player.classList.toggle('is-playing', sound.playing);
            }

            function seek() {

            }

            function start() {
                // waveform = sound.waveform(360);

                drawWaveform(ctxA, colorWaveform, 1);

                analyser = sound.effect.analyser({
                    fftSize: 512,
                    smoothingTimeConstant: 0.9
                });

                inner.addEventListener('click', togglePlay);
            }

        }());
    </script>
</body>
</html>




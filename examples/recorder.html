<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Sono - Examples - Recorder</title>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <h1>Recorder</h1>

    <section>

        <div class="Player-effect-panel is-visible">
            <button class="Player-button" data-js="button" disabled>RECORD</button>
            <p class="Player-info">TIME: <output data-js="output">0</output></p>
        </div>
        <canvas data-js="waveform" width="420", height="120"></canvas>

    </section>

    <script>
        // Test with no WebAudio
        if(window.location.search.substring(1) === 'nowebaudio') {
            window.AudioContext = window.webkitAudioContext = undefined;
        }
    </script>
    <script src="../dist/sono.js"></script>
    <script src="js/player.js"></script>
    <script>
        (function() {
            'use strict';

            var sound,
                recorder,
                recordingCount = 0,
                analyser,
                context,
                button = document.querySelector('[data-js="button"]'),
                output = document.querySelector('[data-js="output"]'),
                canvas = document.querySelector('[data-js="waveform"]');

            var onConnect = function(stream) {
                sound = Sono.createSound(stream);
                analyser = sound.effect.analyser(2048);
                analyser.maxDecibels = -60;
                context = canvas.getContext('2d');
                recorder = sound.effect.recorder(false);
                update();

                recorder.start();
            };
            var mic = Sono.utils.microphone(onConnect);

            button.disabled = false;
            button.addEventListener('click', function() {
                if(recorder && recorder.isRecording) {
                    recordingCount++;
                    var recording = recorder.stop();
                    createPlayer(recording);
                    this.innerHTML = 'RECORD';
                }
                else {
                    if(mic.stream) {
                        recorder.start();
                    }
                    else {
                        mic.connect();
                    }
                    this.innerHTML = 'STOP';
                }
            });

            function createPlayer(buffer) {
                var h3 = document.createElement('h3');
                h3.innerHTML = 'Recording ' + recordingCount;
                document.body.appendChild(h3);
                var el = document.createElement('div');
                document.body.appendChild(el);
                new Player(Sono.createSound(buffer), el);
            }

            function update() {
                window.requestAnimationFrame(update);

                output.value = recorder.getDuration().toFixed(1);

                var width = canvas.width,
                    height = canvas.height,
                    frequencyBinCount = analyser.frequencyBinCount,
                    barWidth = Math.max(1, Math.round(width/frequencyBinCount)),
                    magnitude,
                    percent,
                    hue;

                context.fillStyle = '#333333';
                context.fillRect(0, 0, width, height);

                var waveData = analyser.getFrequencies();
                var freqData = analyser.getWaveform();

                for (var i = 0; i < frequencyBinCount; i++) {
                    magnitude = freqData[i];
                    percent = magnitude / 256;
                    hue = i / frequencyBinCount * 360;
                    context.fillStyle = 'hsl(' + hue + ', 100%, 30%)';
                    context.fillRect(barWidth * i, height, barWidth, 0 - height * percent);

                    magnitude = waveData[i];
                    percent = magnitude / 256;
                    hue = i / frequencyBinCount * 360;
                    context.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
                    context.fillRect(barWidth * i, height - height * percent - 1, 2, 2);
                }
            }

        }());
    </script>
</body>
</html>

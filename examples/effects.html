<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Sono - Examples - Effects</title>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <h1>Effects</h1>

    <section>

        <div data-js="buttons"></div>

        <div data-js="player"></div>

        <div data-js="controls"></div>

    </section>

    <script>
        // Test with no WebAudio
        if(window.location.search.substring(1) === 'nowebaudio') {
            window.AudioContext = window.webkitAudioContext = undefined;
        }
    </script>
    <script src="../dist/sono.js"></script>
    <script src="js/player.js"></script>
    <script>
        (function() {
            'use strict';

            Sono.log();

            var sound = Sono.createSound(['audio/music.ogg', 'audio/music.mp3']);
            new Player(sound, document.querySelector('[data-js="player"]'));

            var effects = {
                Compressor: sound.effect.compressor(),
                Distortion: sound.effect.distortion(),
                Echo: sound.effect.echo(0.5, 0.15),
                Flanger: sound.effect.flanger({ stereo: true }),
                Highpass: sound.effect.highpass(2000),
                Lowpass: sound.effect.lowpass(1000),
                Phaser: sound.effect.phaser(),
                //Convolver: sound.effect.convolver(),
                Reverb: sound.effect.reverb()
            };

            var controls = document.querySelector('[data-js="controls"]');
            var buttons = document.querySelector('[data-js="buttons"]');

            Object.keys(effects).forEach(function(key) {
                sound.effect.remove(effects[key]);

                var button = document.createElement('button');
                button.className = 'Player-button';
                button.setAttribute('data-effect', key);
                button.innerHTML = key;
                buttons.appendChild(button);

                var panel = document.createElement('div');
                panel.className = 'Player-effect-panel';
                panel.setAttribute('data-panel', key);
                var header = document.createElement('h3');
                header.innerHTML = key;
                panel.appendChild(header);
                controls.appendChild(panel);
            });

            var removeEffects = function() {
                Object.keys(effects).forEach(function(key) {
                    sound.effect.remove(effects[key]);
                });
            };
            removeEffects();

            var addEffect = function(effect) {
                removeEffects();

                if(effect) {
                    sound.effect.add(effects[effect]);
                }

                var refs = document.querySelectorAll('[data-ref]');
                [].forEach.call(refs, function(ref) {
                    var id = ref.getAttribute('data-ref');
                    ref.style.display = id === effect ? 'block' : 'none';
                });
            };

            var btns = document.querySelectorAll('[data-effect]');
            [].forEach.call(btns, function(btn) {
                btn.addEventListener('click', function() {
                    var isSelected = this.classList.contains('is-selected');
                    var effect = isSelected ? null : this.getAttribute('data-effect');
                    var panels = document.querySelectorAll('[data-panel]');
                    [].forEach.call(panels, function(panel) {
                        var panelId = panel.getAttribute('data-panel');
                        panel.classList.toggle('is-visible', panelId === effect);
                    });
                    [].forEach.call(btns, function(btn) {
                        var btnId = btn.getAttribute('data-effect');
                        btn.classList.toggle('is-selected', btnId === effect);
                    });
                    addEffect(effect);
                });
            });

            // saturation

            /*
                Convolver: sound.effect.convolver(),
            */

            createControls({
                effect: 'Compressor',
                params: [
                    {
                        label: 'Threshold',
                        min: -100,
                        max: 0,
                        step: 1,
                        prop: 'threshold'
                    },
                    {
                        label: 'Knee',
                        min: 0,
                        max: 40,
                        step: 0.5,
                        prop: 'knee'
                    },
                    {
                        label: 'Ratio',
                        min: 1,
                        max: 20,
                        step: 0.5,
                        prop: 'ratio'
                    },
                    {
                        label: 'Reduction',
                        min: -20,
                        max: 0,
                        step: 0.5,
                        prop: 'reduction'
                    },
                    {
                        label: 'Attack',
                        min: 0,
                        max: 1,
                        step: 0.05,
                        prop: 'attack'
                    },
                    {
                        label: 'Release',
                        min: 0,
                        max: 1,
                        step: 0.05,
                        prop: 'release'
                    }
                ]
            });

            createControls({
                effect: 'Distortion',
                params: [
                    {
                        label: 'Amount',
                        min: 0,
                        max: 1,
                        step: 0.01,
                        prop: 'amount'
                    }
                ]
            });

            createControls({
                effect: 'Echo',
                params: [
                    {
                        label: 'Delay',
                        min: 0.0,
                        max: 10.0,
                        step: 0.01,
                        prop: 'delay'
                    },
                    {
                        label: 'Feedback',
                        min: 0.0,
                        max: 0.99,
                        step: 0.001,
                        prop: 'feedback'
                    }
                ]
            });

            createControls({
                effect: 'Flanger',
                params: [
                    {
                        label: 'Delay',
                        min: 0.005,
                        max: 0.05,
                        step: 0.001,
                        prop: 'delay'
                    },
                    {
                        label: 'LFO gain',
                        min: 0.0005,
                        max: 0.005,
                        step: 0.00025,
                        prop: 'lfoGain'
                    },
                    {
                        label: 'LFO frequency',
                        min: 0.05,
                        max: 5.0,
                        step: 0.05,
                        prop: 'lfoFrequency'
                    },
                    {
                        label: 'Feedback',
                        min: 0.0,
                        max: 0.9,
                        step: 0.001,
                        prop: 'feedback'
                    }
                ]
            });

            var sampleRate = Sono.context ? Sono.context.sampleRate : 22050;

            createControls({
                effect: 'Highpass',
                params: [
                    {
                        label: 'Frequency',
                        min: 40,
                        max: sampleRate / 2,
                        step: 1,
                        prop: 'frequency'
                    },
                    {
                        label: 'Quality',
                        min: 0,
                        max: 100,
                        step: 1,
                        prop: 'Q'
                    },
                    {
                        label: 'Gain',
                        min: -60,
                        max: 60,
                        step: 1,
                        prop: 'gain'
                    }
                ]
            });

            createControls({
                effect: 'Lowpass',
                params: [
                    {
                        label: 'Frequency',
                        min: 40,
                        max: sampleRate / 2,
                        step: 1,
                        prop: 'frequency'
                    },
                    {
                        label: 'Quality',
                        min: 0,
                        max: 100,
                        step: 1,
                        prop: 'Q'
                    },
                    {
                        label: 'Gain',
                        min: -60,
                        max: 60,
                        step: 1,
                        prop: 'gain'
                    }
                ]
            });

            createControls({
                effect: 'Phaser',
                params: [
                    {
                        label: 'LFO gain',
                        min: 0.0005,
                        max: 1000,
                        step: 0.00025,
                        prop: 'lfoGain'
                    },
                    {
                        label: 'LFO frequency',
                        min: 0.05,
                        max: 5.0,
                        step: 0.05,
                        prop: 'lfoFrequency'
                    },
                    {
                        label: 'Feedback',
                        min: 0.0,
                        max: 0.9,
                        step: 0.001,
                        prop: 'feedback'
                    }
                ]
            });

            createControls({
                effect: 'Reverb',
                params: [
                    {
                        label: 'Time',
                        min: 0,
                        max: 20,
                        step: 0.1,
                        prop: 'time'
                    },
                    {
                        label: 'Decay',
                        min: 0,
                        max: 20,
                        step: 0.1,
                        prop: 'decay'
                    },
                    {
                        label: 'Reverse',
                        min: 0,
                        max: 1,
                        step: 1,
                        prop: 'reverse',
                        type: 'boolean'
                    }
                ]
            });

            function createControls(config) {
                var effect = config.effect;
                var params = config.params;

                var el = document.querySelector('[data-panel="' + effect + '"]');
                var node = effects[effect];

                params.forEach(function(param) {
                    new Slider({
                        parent: el,
                        label: param.label,
                        min: param.min,
                        max: param.max,
                        step: param.step,
                        value: node[param.prop],
                        callback: function() {
                            var value = this.value;
                            if(param.type === 'boolean') {
                                value = !!parseInt(value);
                            }
                            if(node[param.prop].hasOwnProperty('value')) {
                                node[param.prop].value = value;
                            }
                            else {
                                node[param.prop] = value;
                            }
                        }
                    });
                });
            }

            function Slider(config) {
                config.min = config.min || 0;
                config.max = config.max || 1;
                config.step = config.step || 0.01;
                config.value = config.value || 0;

                var lbl = document.createElement('h4');
                    lbl.innerHTML = config.label || '';
                var min = document.createElement('span');
                    min.className = 'Player-slider-limit';
                    min.innerHTML = config.min;
                var max = document.createElement('span');
                    max.className = 'Player-slider-limit';
                    max.innerHTML = config.max;
                var input = document.createElement('input');
                    input.className = 'Player-slider-input Player-slider-input--wide';
                    input.setAttribute('type', 'range');
                    input.setAttribute('min', config.min);
                    input.setAttribute('max', config.max);
                    input.setAttribute('step', config.step);
                    input.setAttribute('value', config.value);
                if(typeof config.callback === 'function') {
                    var onChange = function() {
                        config.callback.call(config.context || this, this.value);
                    };
                    input.addEventListener('change', onChange);
                }
                var output = document.createElement('span');
                    output.className = 'Player-slider-output';
                    output.innerHTML = input.value;
                var form = document.createElement('form');
                    form.className = 'Player-slider';
                    form.addEventListener('input', function() {
                        output.innerHTML = input.value;
                    });
                    form.appendChild(lbl);
                    lbl.appendChild(output);
                    form.appendChild(min);
                    form.appendChild(input);
                    form.appendChild(max);
                if(config.parent) {
                    config.parent.appendChild(form);
                }
                this.input = input;
                this.el = form;
            }

        }());
    </script>
</body>
</html>

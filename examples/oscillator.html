<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, minimal-ui">
    <title></title>
    <link href="css/styles.css" rel="stylesheet">
</head>
<body>
    <h1>Oscillator</h1>

    <div class="Player js-player">
        <div class="Player-waveform">
            <canvas class="Player-waveform-inner js-waveform-back" width="400", height="80"></canvas>
        </div>
        <div class="Player-controls">
            <button class="Player-button">PLAY</button>
            <div class="Player-slider">Freq
                <span>0</span><input class="Player-slider-input js-freq" type="range" min="0" max="100" value="10" /><span>1</span>
            </div>
            <div class="Player-slider">Dist
                <span>0</span><input class="Player-slider-input js-distort" type="range" min="0" max="100" value="100" /><span>1</span>
            </div>
            <div class="Player-info"></div>
        </div>
    </div>

    <script>
        // Test with no WebAudio
        //window.AudioContext = window.webkitAudioContext = undefined;
    </script>
    <script src="../dist/sono.js"></script>
    <script>
        (function() {
            'use strict';

            Sono.volume = 0.2;

            var sineWave = Sono.createSound('sine');

            var distort = sineWave.node.distortion();

            var analyser = sineWave.node.analyser(2048);

            var waveform = document.querySelector('.js-waveform-back'),
                info = document.querySelector('.Player-info');

            // play/pause button
            var button = document.querySelector('.Player-button');
            button.addEventListener('click', function() {
                if(sineWave.playing) {
                    sineWave.pause();
                    button.innerHTML = 'PLAY';
                }
                else {
                    sineWave.play();
                    button.innerHTML = 'PAUSE';
                    //draw();
                }
            });

            // freq slider
            info.innerHTML = sineWave.frequency.toFixed() + 'hz';
            var freqSlider = document.querySelector('.js-freq');
            freqSlider.addEventListener('change', function() {
                var f = Sono.utils.getFrequency(this.value / 100);
                sineWave.frequency = f;
                info.innerHTML = f.toFixed() + 'hz';
            });

            // distort slider
            var distortSlider = document.querySelector('.js-distort');
            distortSlider.addEventListener('change', function() {
                //distort.update(this.value / 100);
                distort.amount = this.value / 100;
            });

            new AnalyserDisplay(analyser, waveform);

            function AnalyserDisplay(analyserNode, canvas) {

                var context = canvas.getContext('2d');


                function draw() {
                    window.requestAnimationFrame(draw);

                    var width = canvas.width,
                        height = canvas.height,
                        frequencyBinCount = analyserNode.frequencyBinCount,
                        barWidth = Math.max(1, Math.round(width/frequencyBinCount));

                        context.fillStyle = '#333333';
                        context.fillRect(0, 0, width, height);


                    var freqByteData = new Uint8Array(frequencyBinCount);
                    
                    /*analyserNode.getByteFrequencyData(freqByteData);

                    for (var i = 0; i < frequencyBinCount; i++) {
                        var magnitude = freqByteData[i];
                        var percent = magnitude / 256;
                        var hue = i/frequencyBinCount * 360;
                        context.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
                        context.fillRect(barWidth * i, height, barWidth - barSpacing, 0 - height * percent);
                    }*/

                    analyserNode.getByteTimeDomainData(freqByteData);

                    for (var i = 0; i < frequencyBinCount; i++) {
                        var magnitude = freqByteData[i];
                        var percent = magnitude / 256;
                        var hue = i/frequencyBinCount * 360;
                        context.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
                        context.fillRect(barWidth * i, height - height * percent - 1, 1, 1);
                    }
                }
                draw();
            }

        }());
    </script>
</body>
</html>

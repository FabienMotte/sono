<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, minimal-ui">
	<title>Sono</title>
	<link href="css/styles.css" rel="stylesheet">
</head>
<body>
	<h1>sono</h1>

    <ul>
        <li><a href="player.html">Player</a></li>
        <li><a href="oscillator.html">Oscillator</a></li>
        <li><a href="microphone.html">Microphone</a></li>
        <li><a href="video.html">Video</a></li>

        <li>Simple example</li>
        <li>WebAudio</li>
        <li>Audio el v Array Buffer</li>
        <li>Video el</li>
        <li>Crazy ones like video texture in THREE.js (a TV?)</li>
        <li>Game e.g. different environments/rooms?</li>
    </ul>


    <h3>Browser support</h3>
    <ul class="js-support"></ul>



    <h3>Player A</h3>

    <div class="Player js-playerA">
        <div class="Player-waveform">
            <canvas class="Player-waveform-inner js-waveform-back" width="400", height="80"></canvas>
            <div class="Player-waveform-inner Player-waveform-clip js-waveform-progress">
                <canvas class="js-waveform-front" width="400", height="80"></canvas>
            </div>
        </div>
        <div class="Player-controls">
            <button class="Player-button">PLAY</button>
            <div class="Player-slider">
                <span>0</span><input class="Player-slider-input js-volume" type="range" min="0" max="100" value="100" /><span>1</span>
            </div>
            <div class="Player-slider">
                <span>L</span><input class="Player-slider-input js-pan" type="range" min="-100" max="100" value="0" /><span>R</span>
            </div>
            <div class="Player-info"></div>
        </div>
    </div>

    <h3>Player B</h3>

    <div class="Player js-playerB">
        <div class="Player-waveform">
            <canvas class="Player-waveform-inner js-waveform-back" width="400", height="80"></canvas>
            <div class="Player-waveform-inner Player-waveform-clip js-waveform-progress">
                <canvas class="js-waveform-front" width="400", height="80"></canvas>
            </div>
        </div>
        <div class="Player-controls">
            <button class="Player-button">PLAY</button>
            <div class="Player-slider">
                <span>0</span><input class="Player-slider-input js-volume" type="range" min="0" max="100" value="100" /><span>1</span>
            </div>
            <div class="Player-slider">
                <span>L</span><input class="Player-slider-input js-pan" type="range" min="-100" max="100" value="0" /><span>R</span>
            </div>
            <div class="Player-info"></div>
        </div>
    </div>



    <h3>Master volume</h3>
    <div><input class="js-master-volume" type="range" min="0" max="100" value="100" /><div>

    <script>
        // Test with no WebAudio
        //window.AudioContext = window.webkitAudioContext = undefined;
    </script>
	<script src="../dist/sono.min.js"></script>
    <script>
        (function() {
            'use strict';

            Sono.log();

            var support = document.querySelector('.js-support');
            var info = '<li>Audio Support: ' + Sono.isSupported + '</li>' +
                       '<li>WebAudio API: ' + Sono.hasWebAudio + '</li>' +
                       '<li>Touch Locked: ' + Sono._isTouchLocked + '</li>' +
                       '<li>Extensions: ' + Sono._support.extensions.join(', ') + '</li>';
            support.innerHTML = info;

            /*var soundA = Sono.load(['audio/VOX.ogg', 'audio/VOX.mp3'], function(sound) {
                new Player(sound, '.js-playerA');
            });*/
            /*soundA.loader.onProgress.add(function(progress) {
                console.log(progress);
            });*/
            //this.sound.loop = true;
            //this.sound.node.reverb(0.2, 0.5);
            //Sono.node.delay(soundA._gain, 0.5, 0.5);

            /*var soundB = Sono.load(['audio/TEST.ogg', 'audio/TEST.mp3'], function(sound) {
                new Player(sound, '.js-playerB');
            });*/

            // master gain
            var masterVolumeSlider = document.querySelector('.js-master-volume');
            masterVolumeSlider.addEventListener('change', function() {
                Sono.volume = this.value / 100;
            });

            var sounds = [
                { id: 'a', url: ['audio/TEST.ogg', 'audio/TEST.mp3'] },
                { id: 'b', url: ['audio/VOX.ogg', 'audio/VOX.mp3'] }
            ];

            Sono.load(sounds, function(loaded) {
                console.log('all loaded:', loaded)

                var a = Sono.getById('a');
                var b = Sono.getById('b');

                console.log(Sono.getById(sounds[0].id) === a, a);
                console.log(Sono.getById(sounds[1].id) === b, b);

                new Player(a, '.js-playerA');
                new Player(b, '.js-playerB');

                //Sono.getById('a').node.reverb(4, 10);
                //var delay = Sono.node.delay(Sono.getById('b')._gain, 0.5, 0.5);
                //Sono.node.delay(delay, 2, 0.2)

                //var delay = Sono.node.delay(Sono.masterGain, 0.5, 0.5);
                var delay = a.node.delay(a.gain, 0.2, 0.5);
                //var reverb = a.node.reverb(0.5, 0.5);
                //delay.disconnect();

                //Sono.node.reverb(4, 10);

            }, function(progress) {
                console.log('progress:', progress);
            });


            function Player(sound, selector) {

                var view = document.querySelector(selector),
                    waveform = view.querySelector('.Player-waveform'),
                    waveformBack = view.querySelector('.js-waveform-back'),
                    waveformFront = view.querySelector('.js-waveform-front'),
                    waveformProgress = view.querySelector('.js-waveform-progress'),
                    button = view.querySelector('.Player-button'),
                    volumeSlider = view.querySelector('.js-volume'),
                    panSlider = view.querySelector('.js-pan'),
                    info = view.querySelector('.Player-info');

                // update time and waveform
                function update() {
                    if(sound.playing) {
                        window.requestAnimationFrame(update);
                    }

                    info.innerHTML = Sono.utils.timeCode(sound.currentTime) + ' / ' +
                                     Sono.utils.timeCode(sound.duration);

                    waveformProgress.style.width = (sound.progress * 100).toFixed(1) + '%';
                }
                update();

                // play/pause button
                button.addEventListener('click', function() {
                    if(sound.playing) {
                        sound.pause();
                        button.innerHTML = 'PLAY';
                    }
                    else {
                        sound.play();
                        button.innerHTML = 'PAUSE';
                        update();
                    }
                });

                // reset button when sound ended
                sound.onEnded(function() {
                    button.innerHTML = 'PLAY';
                });

                // volume slider
                volumeSlider.addEventListener('change', function() {
                    sound.volume = this.value / 100;
                });

                var panner = sound.node.panner();
                var pan = Sono.utils.pan(panner);

                // pan slider
                panSlider.addEventListener('change', function() {
                    pan.x(this.value / 100);
                });

                // waveform display
                var wave = Sono.utils.waveform(sound._data, waveformBack.width);
                var height = waveformBack.height;
                wave.getCanvas(height, '#333333', '#dddddd', waveformBack);
                //Sono.utils.waveformCanvas(waveformData, height, '#00ffff', '#444444', waveformFront);
                wave.getCanvas(height, '#dddddd', '#333333', waveformFront);

                // click waveform to seek
                waveform.addEventListener('click', function(event) {
                    var rect = waveform.getBoundingClientRect();
                    //console.log('click waveform', event.clientX - rect.left, rect.width);
                    var percent = (event.clientX - rect.left) / rect.width;
                    sound.seek(percent);

                    button.innerHTML = 'PAUSE';
                    update();
                });
            }

        }());
    </script>
</body>
</html>

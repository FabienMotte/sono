<!DOCTYPE html>
<!--[if lt IE 9]><html lang="en" class="no-js old-ie"><![endif]-->
<!--[if gt IE 9]><!--><html lang="en" class="no-js"><!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, minimal-ui">

	<meta name="description" content="">
    <meta name="idwords" content="">

    <meta property="og:title" content="">
    <meta property="og:site_name" content="">
    <meta property="og:description" content="">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <link rel="image_src" href="">
    <link rel="shortcut icon" href="favicon.ico">

	<title></title>
	<link href="css/styles.css" rel="stylesheet">
	<script src="js/modernizr/modernizr.js"></script>
</head>
<body>
	<h1>sono</h1>

    <ul>
        <li>Simple example</li>
        <li>WebAudio</li>
        <li>Audio el v Array Buffer</li>
        <li>Video el</li>
        <li>Crazy ones like video texture in THREE.js (a TV?)</li>
        <li>Game e.g. different environments/rooms?</li>
    </ul>

    <div class="js-output-a"></div>
    <canvas class="js-waveform-a" width="400", height="80"></canvas>
    <div><button class="js-playpause-a">PLAY</button><div>
    <div><input class="js-volume-a" type="range" min="0" max="100" value="100" /><div>
    
    <div class="js-output-b"></div>
    <canvas class="js-waveform-b" width="400", height="80"></canvas>
    <div><button class="js-playpause-b">PLAY</button><div>
    <div><input class="js-volume-b" type="range" min="0" max="100" value="100" /><div>

    <h3>master volume</h3>
    <div><input class="js-volume" type="range" min="0" max="100" value="100" /><div>

    <script>
        // Test with no WebAudio
        //window.AudioContext = window.webkitAudioContext = undefined;
    </script>
	<script src="../dist/sono.js"></script>
    <script src="../bower_components/usfl/dist/usfl.js"></script>
    <script src="../bower_components/usfl/src/lib/graphics.js"></script>
    <script>
        (function() {
            'use strict';

            var output = document.querySelector('.js-output-a'),
                outputB = document.querySelector('.js-output-b'),
                playpause = document.querySelector('.js-playpause-a'),
                playpauseB = document.querySelector('.js-playpause-b'),
                canvas = document.querySelector('.js-waveform-a'),
                canvasB = document.querySelector('.js-waveform-b'),
                volumeA = document.querySelector('.js-volume-a'),
                volumeB = document.querySelector('.js-volume-b'),
                volume = document.querySelector('.js-volume');


            var graphics = new Graphics(canvas);
            graphics.clear('#eeeeee');
            graphics.fill(128, 0, 0, 40);

            var graphicsB = new Graphics(canvasB);
            graphicsB.clear('#eeeeee');
            graphicsB.fill(128, 0, 0, 40);

            //Sono.context = null;
            //Sono.log();
            //console.log('Sono:', Sono);=

            //var urls;
            // will load this file
            //url = 'audio/TEST.ogg';
            // will load first key compatible with browser
            //url = { foo: 'audio/TEST.ogg', bar: 'audio/TEST.mp3' };
            // will load first index compatible with browser
            //urls = ['audio/TEST.ogg', 'audio/TEST.mp3'];
            //urls = ['audio/VOX.ogg', 'audio/VOX.mp3'];
            // will add first compatible extension
            //url = 'audio/TEST';

            var soundLoadProgress = function(progress) {
                //console.log('soundLoadProgress', progress);
            };

            var waveform, waveformB;

            function drawPeak(waveform, graphics, i) {
                if(waveform === undefined) {
                    return;
                }
                var x = i + 0.5,
                    h = graphics.height,
                    y = h - Math.round(h * waveform[i]);
                //console.log(h);
                graphics.line(x, y, x, h);
            }

            // test no WebAudio
            //SONO.context = null;
            var sound = Sono.load(['audio/VOX.ogg', 'audio/VOX.mp3'], getLoadedHandler(graphics));
            //var sound = Sono.add(urls);
            //.play();
            //sound.loop = true;
            sound.loader.onProgress.add(soundLoadProgress, this);
            //this.sound.loop = true;
            //this.sound.addNode(SONO.create.reverb(0.2, 0.5));
            var delay = Sono.create.delay(sound._gain, 0.5, 0.5);

            addButtonHandler(playpause, sound);
            addVolumeHandler(volumeA, sound)

            var soundB = Sono.load(['audio/TEST.ogg', 'audio/TEST.mp3'], getLoadedHandler(graphicsB));
            addButtonHandler(playpauseB, soundB);
            addVolumeHandler(volumeB, soundB);


            addVolumeHandler(volume, Sono);

            function addVolumeHandler(slider, sound) {
                var onVolumeChange = function() {
                    sound.volume = this.value / 100;
                };
                slider.addEventListener('change', onVolumeChange);
            }

            
            function getLoadedHandler(graphics) {
                return function(sound) {
                    sound.waveform = Sono.utils.waveform(sound._data, canvas.width);

                    for (var i = 0; i < sound.waveform.length; i++) {
                        drawPeak(sound.waveform, graphics, i);
                    }
                    graphics.stroke(128, 0, 0)
                };
            }

            function addButtonHandler(button, sound) {
                button.addEventListener('click', function() {
                    if(sound.playing) {
                        sound.pause();
                        button.innerHTML = 'PLAY';
                    }
                    else {
                        sound.play();
                        button.innerHTML = 'PAUSE';
                    }
                });
                sound.onEnded(function() {
                    button.innerHTML = 'PLAY';
                });
            }

            function updateOutput(el, sound) {
                el.innerHTML = sound.currentTime.toFixed(2) + ' / ' +
                               sound.duration.toFixed(2) + ' / ' +
                               sound.progress.toFixed(2);
            }

            function updateWaveform(waveform, graphics, progress) {
                var i = Math.floor(graphics.width * progress);
                drawPeak(waveform, graphics, i);            
            }

            function update() {
                window.requestAnimationFrame(update);
                
                updateOutput(output, sound);
                updateOutput(outputB, soundB);
                
                updateWaveform(sound.waveform, graphics, sound.progress);
                updateWaveform(soundB.waveform, graphicsB, soundB.progress);
            }
            update();


            var sounds = [
                { id: 'a', url: ['audio/TEST.ogg', 'audio/TEST.mp3'] },
                { id: 'b', url: ['audio/VOX.ogg', 'audio/VOX.mp3'] }
            ];

            Sono.load(sounds, function(loaded) {
                console.log('all loaded:', loaded)
                console.log(Sono.get(sounds[0].id) === Sono.get('a'), Sono.get('a'));
                console.log(Sono.get(sounds[1].id) === Sono.get('b'), Sono.get('b'));
            }, function(progress) {
                console.log('progress:', progress);
            });

        }());
    </script>
</body>
</html>
